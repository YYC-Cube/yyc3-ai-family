# YYC³ AI Family 数据库与模型架构文档

> ***YanYuCloudCube***
> 言启象限 | 语枢未来

---

**文档版本**: 1.0.0
**创建日期**: 2026-02-22
**适用项目**: YYC³ AI Family v0.33.0

---

## 📋 目录

1. [集群架构总览](#1-集群架构总览)
2. [数据库架构详解](#2-数据库架构详解)
3. [AI 模型分布架构](#3-ai-模型分布架构)
4. [七大智能体模型映射](#4-七大智能体模型映射)
5. [网络端口规范](#5-网络端口规范)
6. [故障排查指南](#6-故障排查指南)

---

## 1. 集群架构总览

### 1.1 三节点拓扑

```
                    ┌─────────────────────────────────────────────────────────────┐
                    │                    YYC³ Cluster Network                      │
                    │                      192.168.3.x/24                          │
                    └────────────────────────────┬────────────────────────────────┘
                                                 │
            ┌────────────────────────────────────┼────────────────────────────────────┐
            │                                    │                                    │
       ┌────┴────┐                        ┌──────┴──────┐                      ┌────┴────┐
       │ M4 Max  │                        │ YanYuCloud  │                      │ iMac M4 │
       │ (Main)  │◄──────────────────────►│    NAS      │◄────────────────────►│ (Aux)   │
       │ 编排器   │                        │  数据中心    │                      │ 辅助节点  │
       └────┬────┘                        └──────┬──────┘                      └────┬────┘
            │                                    │                                   │
            │  ┌─────────────────────────────────┼─────────────────────────────────┐
            │  │                                 │                                 │
            ▼  ▼                                 ▼                                 ▼ ▼
    ┌───────────────┐                   ┌───────────────┐                  ┌───────────────┐
    │ PostgreSQL 15 │                   │ PostgreSQL 13 │                  │ Ollama        │
    │ Redis         │                   │ pgvector      │                  │ GLM4, Phi3    │
    │ Ollama        │                   │ MySQL         │                  │ CodeGeeX4     │
    │ 前端服务      │                   │ Redis         │                  │ Mixtral       │
    └───────────────┘                   └───────────────┘                  └───────────────┘
```

### 1.2 节点角色定义

| 节点 | IP 地址 | 角色 | 核心职责 |
|------|---------|------|----------|
| **M4 Max** | localhost / 192.168.3.22 | 编排器 (主节点) | 前端服务、主数据库、AI 推理 |
| **YanYuCloud NAS** | 192.168.3.45 | 数据中心 | 向量数据库、文件存储、备份 |
| **iMac M4** | 192.168.3.77 | 辅助节点 | AI 模型推理、负载分担 |

---

## 2. 数据库架构详解

### 2.1 数据库分布矩阵

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           YYC³ 数据库架构                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   M4 Max (主节点)                    NAS (数据中心)                              │
│   ┌─────────────────────┐           ┌─────────────────────┐                     │
│   │ PostgreSQL 15       │           │ PostgreSQL 13       │                     │
│   │ 端口: 5433          │           │ 端口: 5032 (系统)   │                     │
│   │ 用途: 主数据库       │           │ 端口: 5432 (应用)   │                     │
│   │ 数据库: yyc3_aify   │◄─────────►│ 用途: 系统服务       │                     │
│   │                     │           │                     │                     │
│   │ Redis               │           │ pgvector (Docker)   │                     │
│   │ 端口: 6379          │           │ 端口: 5434          │                     │
│   │ 用途: 缓存/会话      │           │ 用途: 向量存储       │                     │
│   │                     │           │ 数据库: yyc3_vectors│                     │
│   │                     │           │                     │                     │
│   │                     │           │ MySQL               │                     │
│   │                     │           │ 端口: 3306          │                     │
│   │                     │           │ 用途: 应用数据       │                     │
│   │                     │           │                     │                     │
│   │                     │           │ Redis               │                     │
│   │                     │           │ 端口: 6379          │                     │
│   │                     │           │ 用途: 缓存           │                     │
│   └─────────────────────┘           └─────────────────────┘                     │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 M4 Max 本地数据库

| 服务 | 端口 | 版本 | 用途 | 状态 |
|------|------|------|------|------|
| **PostgreSQL 15** | 5433 | v15 | 主数据库 (yyc3_aify) | ✅ 运行中 |
| **Redis** | 6379 | v7.x | 缓存/会话管理 | ✅ 运行中 |

**PostgreSQL 15 数据库**:

- 数据库名: `yyc3_aify`
- 主机: `localhost`
- 端口: `5433`
- 用途: AI Family 主数据存储

### 2.3 NAS 数据库服务

| 服务 | 端口 | 版本 | 用途 | 状态 |
|------|------|------|------|------|
| **PostgreSQL 13 (系统)** | 5032 | v13 | TNAS 系统服务 | ✅ 运行中 |
| **PostgreSQL_okm (应用)** | 5432 | v14 | 应用数据库 | ✅ 运行中 |
| **pgvector (Docker)** | 5434 | v14 + pgvector | 向量数据库 | ✅ 运行中 |
| **MySQL** | 3306 | v8.x | 应用数据 | ✅ 运行中 |
| **Redis** | 6379 | v7.x | 缓存服务 | ✅ 运行中 |

**pgvector 向量数据库**:

- 容器名: `yyc3-pgvector`
- 数据库名: `yyc3_vectors`
- 主机: `192.168.3.45`
- 端口: `5434`
- 用户: `yyc3`
- 用途: AI 向量存储与检索

### 2.4 数据流向

```
┌─────────────────────────────────────────────────────────────────┐
│                        数据流向架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   前端 (M4 Max)                                                 │
│        │                                                        │
│        ▼                                                        │
│   ┌─────────────┐                                               │
│   │ PostgreSQL  │◄────── 结构化数据存储                         │
│   │   (5433)    │                                               │
│   └─────────────┘                                               │
│        │                                                        │
│        ▼                                                        │
│   ┌─────────────┐     ┌─────────────┐                           │
│   │   Redis     │◄───►│  pgvector   │◄─── 向量检索              │
│   │   (6379)    │     │   (5434)    │                           │
│   └─────────────┘     └─────────────┘                           │
│        │                    │                                   │
│        │                    │                                   │
│        ▼                    ▼                                   │
│   ┌─────────────────────────────────┐                           │
│   │         NAS 存储 (32TB)          │                          │
│   │      文件备份 / 模型缓存          │                          │
│   └─────────────────────────────────┘                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. AI 模型分布架构

### 3.1 模型分布总览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           YYC³ AI 模型分布                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   M4 Max (主节点)                    iMac M4 (辅助节点)                          │
│   ┌─────────────────────┐           ┌─────────────────────┐                     │
│   │ Ollama :11434       │           │ Ollama :11434       │                     │
│   ├─────────────────────┤           ├─────────────────────┤                     │
│   │ codegeex4:latest    │  5GB      │ glm4:9b             │  5GB                │
│   │ qwen2.5:7b          │  4GB      │ phi3:mini           │  2GB                │
│   │ gpt-oss:120b-cloud  │  云端     │ codegeex4:latest    │  5GB                │
│   │ nomic-embed-text    │  嵌入     │ phi3:14b            │  7GB                │
│   │ deepseek-v3.1:cloud │  云端     │ llama3:latest       │  4GB                │
│   │ qwen2.5-coder:1.5b  │  轻量     │ codellama:latest    │  3GB                │
│   │                     │           │ mixtral:latest      │  24GB               │
│   └─────────────────────┘           └─────────────────────┘                     │
│         │                                    │                                 │
│         │                                    │                                 │
│         ▼                                    ▼                                 │
│   ┌─────────────────────────────────────────────────────────────┐              │
│   │                    NAS Ollama :11434                         │              │
│   │                    (备用/负载均衡)                            │              │
│   └─────────────────────────────────────────────────────────────┘              │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 M4 Max 模型清单

| 模型 | 大小 | 用途 | 类型 |
|------|------|------|------|
| **codegeex4:latest** | 5GB | 代码生成 | 本地 |
| **qwen2.5:7b** | 4GB | 通用对话 | 本地 |
| **gpt-oss:120b-cloud** | - | 云端推理 | 云端 |
| **nomic-embed-text:latest** | - | 文本嵌入 | 本地 |
| **deepseek-v3.1:671b-cloud** | - | 云端推理 | 云端 |
| **qwen2.5-coder:1.5b** | - | 代码补全 | 本地 |

### 3.3 iMac M4 模型清单

| 模型 | 大小 | 用途 | 类型 |
|------|------|------|------|
| **glm4:9b** | 5GB | 中文对话 | 本地 |
| **phi3:mini** | 2GB | 轻量推理 | 本地 |
| **codegeex4:latest** | 5GB | 代码生成 | 本地 |
| **phi3:14b** | 7GB | 中等推理 | 本地 |
| **llama3:latest** | 4GB | 通用对话 | 本地 |
| **codellama:latest** | 3GB | 代码生成 | 本地 |
| **mixtral:latest** | 24GB | 混合专家 | 本地 |

**iMac 总模型大小**: ~50GB

---

## 4. 七大智能体模型映射

### 4.1 智能体与模型对应关系

| 智能体 | 角色 | 主模型 | 部署节点 | 备用模型 | 端点 |
|--------|------|--------|----------|----------|------|
| **Navigator** | 领航员 | qwen2.5:7b | M4 Max | codegeex4 | localhost:11434 |
| **Thinker** | 思想家 | DeepSeek-V3 | Cloud API | codegeex4 | api.deepseek.com |
| **Prophet** | 先知 | qwen2.5:7b | M4 Max | glm4:9b | localhost:11434 |
| **Bole** | 伯乐 | codegeex4 | iMac M4 | codegeex4 (M4) | 192.168.3.77:11434 |
| **Pivot** | 天枢 | glm4:9b | iMac M4 | qwen2.5:7b | 192.168.3.77:11434 |
| **Sentinel** | 哨兵 | phi3:mini | iMac M4 | phi3:14b | 192.168.3.77:11434 |
| **Grandmaster** | 宗师 | DeepSeek-V3 | Cloud API | mixtral | api.deepseek.com |

### 4.2 智能体推理延迟

| 智能体 | 模型 | 节点 | 平均延迟 | 评级 |
|--------|------|------|----------|------|
| Navigator | qwen2.5:7b | M4 Max | ~3000ms | ⭐⭐⭐⭐⭐ |
| Bole | codegeex4 | iMac M4 | ~13500ms | ⭐⭐⭐ |
| Pivot | glm4:9b | iMac M4 | ~11000ms | ⭐⭐⭐ |
| Sentinel | phi3:mini | iMac M4 | ~9800ms | ⭐⭐⭐⭐ |

### 4.3 负载均衡策略

```
┌─────────────────────────────────────────────────────────────────┐
│                     智能体负载均衡                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   高频调用 (M4 Max)                                             │
│   ├── Navigator (领航员) - qwen2.5:7b                          │
│   └── Prophet (先知) - qwen2.5:7b                              │
│                                                                 │
│   中频调用 (iMac M4)                                            │
│   ├── Bole (伯乐) - codegeex4                                  │
│   ├── Pivot (天枢) - glm4:9b                                   │
│   └── Sentinel (哨兵) - phi3:mini                              │
│                                                                 │
│   云端调用 (API)                                                │
│   ├── Thinker (思想家) - DeepSeek-V3                           │
│   └── Grandmaster (宗师) - DeepSeek-V3                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 网络端口规范

### 5.1 端口分配表

| 端口范围 | 用途 | 说明 |
|----------|------|------|
| **3000-3199** | 限用 | 避免使用 |
| **3200-3500** | 默认 | AI Family 服务 |

### 5.2 服务端口映射

#### M4 Max (主节点)

| 服务 | 端口 | 协议 | 用途 |
|------|------|------|------|
| Vite Dev Server | 3113 | HTTP | 前端开发服务器 |
| PostgreSQL 15 | 5433 | TCP | 主数据库 |
| Redis | 6379 | TCP | 缓存服务 |
| Ollama | 11434 | HTTP | AI 模型推理 |

#### NAS (数据中心)

| 服务 | 端口 | 协议 | 用途 |
|------|------|------|------|
| SSH | 9557 | TCP | 远程访问 |
| PostgreSQL (系统) | 5032 | TCP | 系统数据库 |
| PostgreSQL (应用) | 5432 | TCP | 应用数据库 |
| pgvector | 5434 | TCP | 向量数据库 |
| MySQL | 3306 | TCP | MySQL 数据库 |
| Redis | 6379 | TCP | 缓存服务 |
| Ollama | 11434 | HTTP | AI 模型推理 |
| SQLite HTTP Proxy | 8484 | HTTP | SQLite 代理 |
| Docker API | 2375 | HTTP | Docker 远程 API |
| WebSocket Relay | 9090 | WS | 心跳中继 |
| NAS Web | 9898 | HTTP | 管理界面 |

#### iMac M4 (辅助节点)

| 服务 | 端口 | 协议 | 用途 |
|------|------|------|------|
| SSH | 22 | TCP | 远程访问 |
| Ollama | 11434 | HTTP | AI 模型推理 |

---

## 6. 故障排查指南

### 6.1 NAS Web 频繁退出问题分析

**现象**: NAS Web 管理界面频繁自动退出到登录页面

**可能原因**:

1. **TOS Daemon 高 CPU 占用** (14.1%)
   - TOSDaemon 进程 CPU 占用较高
   - 可能导致会话管理不稳定

2. **Session 超时配置**
   - TNAS 系统默认会话时间较短
   - 建议检查系统设置中的会话超时配置

3. **浏览器 Cookie 问题**
   - Cookie 被阻止或过期
   - 建议清除浏览器缓存后重试

4. **网络不稳定**
   - 导致连接中断
   - 检查网络稳定性

**建议解决方案**:

```bash
# 1. 检查 TOS Daemon 状态
ssh -p 9557 YYC@192.168.3.45 "ps aux | grep TOSDaemon"

# 2. 重启 TOS 服务 (谨慎操作)
ssh -p 9557 YYC@192.168.3.45 "sudo systemctl restart tos"

# 3. 检查系统日志
ssh -p 9557 YYC@192.168.3.45 "dmesg | tail -50"
```

### 6.2 数据库连接问题

**PostgreSQL 连接失败**:

```bash
# 检查服务状态
brew services list | grep postgres

# 启动服务
brew services start postgresql@15

# 检查端口
nc -z -w 2 localhost 5433
```

**Redis 连接失败**:

```bash
# 检查服务状态
brew services list | grep redis

# 启动服务
brew services start redis

# 测试连接
redis-cli ping
```

### 6.3 Ollama 服务问题

**模型推理失败**:

```bash
# 检查 Ollama 服务
curl http://localhost:11434/api/version

# 检查模型列表
curl http://localhost:11434/api/tags

# 重启 Ollama
ollama serve
```

---

## 📊 架构总结

### 当前状态

| 组件 | 状态 | 说明 |
|------|------|------|
| M4 Max 数据库 | ✅ 正常 | PostgreSQL 15 + Redis |
| NAS 数据库 | ✅ 正常 | pgvector + MySQL + Redis |
| iMac 模型服务 | ✅ 正常 | 7 个模型已部署 |
| M4 Max 模型服务 | ✅ 正常 | 6 个模型已部署 |
| 网络连通性 | ✅ 正常 | 三节点互联 |

### 资源占用

| 节点 | 内存使用 | 磁盘使用 | CPU 负载 |
|------|----------|----------|----------|
| M4 Max | ~20GB/128GB | ~500GB/4TB | 低 |
| NAS | ~3.3GB/32GB | ~1TB/32TB | 中 (TOSDaemon 14%) |
| iMac M4 | ~8GB/32GB | ~60GB/2TB | 低 |

---

<div align="center">

**YYC³ AI Family**

*言启象限 | 语枢未来*

**万象归元于云枢 | 深栈智启新纪元**

---

*文档版本: 1.0.0*
*最后更新: 2026-02-22*

</div>
