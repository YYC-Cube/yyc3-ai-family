name: YYC³ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # ========================================
  # 代码质量检查
  # ========================================
  quality-check:
    name: 代码质量检查
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 安装pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: 运行ESLint
        run: pnpm run lint

      - name: 运行TypeScript类型检查
        run: pnpm run type-check

      - name: 运行安全审计
        run: npm audit --production

  # ========================================
  # 数据库同步测试
  # ========================================
  database-sync-test:
    name: 数据库同步测试
    runs-on: ubuntu-latest
    needs: quality-check
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: yyc3_test
          POSTGRES_PASSWORD: yyc3_test_password
          POSTGRES_DB: yyc3_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置环境变量
        run: |
          echo "DB_HOST=localhost" >> $GITHUB_ENV
          echo "DB_PORT=5433" >> $GITHUB_ENV
          echo "DB_NAME=yyc3_test" >> $GITHUB_ENV
          echo "DB_USER=yyc3_test" >> $GITHUB_ENV
          echo "DB_PASSWORD=yyc3_test_password" >> $GITHUB_ENV

      - name: 运行数据库健康检查
        run: bash scripts/db-health-check.sh

      - name: 运行错误恢复测试
        run: bash scripts/test-error-recovery.sh

      - name: 运行日志记录测试
        run: bash scripts/test-logging.sh

      - name: 运行回滚流程测试
        run: bash scripts/test-rollback.sh

      - name: 上传测试日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            /tmp/yyc3-test.log
            /tmp/yyc3-test-logs/
            /tmp/yyc3-rollback-test/
          retention-days: 7

  # ========================================
  # 性能监控测试
  # ========================================
  performance-monitor:
    name: 性能监控测试
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 运行性能监控
        run: bash scripts/performance-monitor.sh

      - name: 上传性能指标
        uses: actions/upload-artifact@v4
        with:
          name: performance-metrics
          path: /tmp/yyc3-metrics/
          retention-days: 30

  # ========================================
  # 集成测试
  # ========================================
  integration-test:
    name: 集成测试
    runs-on: ubuntu-latest
    needs: database-sync-test
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: yyc3_test
          POSTGRES_PASSWORD: yyc3_test_password
          POSTGRES_DB: yyc3_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 安装pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: 设置环境变量
        run: |
          echo "DB_HOST=localhost" >> $GITHUB_ENV
          echo "DB_PORT=5433" >> $GITHUB_ENV
          echo "DB_NAME=yyc3_test" >> $GITHUB_ENV
          echo "DB_USER=yyc3_test" >> $GITHUB_ENV
          echo "DB_PASSWORD=yyc3_test_password" >> $GITHUB_ENV

      - name: 运行集成测试
        run: pnpm run test:integration || echo "集成测试未配置"

      - name: 运行综合测试
        run: bash scripts/test-comprehensive.sh

  # ========================================
  # 性能基准测试
  # ========================================
  performance-benchmark:
    name: 性能基准测试
    runs-on: ubuntu-latest
    needs: quality-check
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: yyc3_test
          POSTGRES_PASSWORD: yyc3_test_password
          POSTGRES_DB: yyc3_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置环境变量
        run: |
          echo "DB_HOST=localhost" >> $GITHUB_ENV
          echo "DB_PORT=5433" >> $GITHUB_ENV
          echo "DB_NAME=yyc3_test" >> $GITHUB_ENV
          echo "DB_USER=yyc3_test" >> $GITHUB_ENV
          echo "DB_PASSWORD=yyc3_test_password" >> $GITHUB_ENV

      - name: 运行性能基准测试
        run: bash scripts/performance-benchmark.sh

      - name: 上传基准测试结果
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: /tmp/yyc3-benchmark/
          retention-days: 90

      - name: 生成性能报告
        run: |
          echo "## 性能基准测试结果" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "详细结果请查看上传的artifacts" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # 告警通知
  # ========================================
  notify:
    name: 告警通知
    runs-on: ubuntu-latest
    needs: [quality-check, database-sync-test, performance-monitor, integration-test, performance-benchmark]
    if: always()
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 发送成功通知
        if: ${{ needs.quality-check.result == 'success' && needs.database-sync-test.result == 'success' && needs.performance-monitor.result == 'success' && needs.integration-test.result == 'success' && needs.performance-benchmark.result == 'success' }}
        run: |
          bash scripts/send-alert.sh \
            --type success \
            --subject "YYC³ CI/CD Pipeline 成功" \
            --message "所有测试和检查已通过" \
            --email admin@0379.email

      - name: 发送失败通知
        if: ${{ needs.quality-check.result == 'failure' || needs.database-sync-test.result == 'failure' || needs.performance-monitor.result == 'failure' || needs.integration-test.result == 'failure' || needs.performance-benchmark.result == 'failure' }}
        run: |
          bash scripts/send-alert.sh \
            --type failure \
            --subject "YYC³ CI/CD Pipeline 失败" \
            --message "部分测试或检查失败，请检查日志" \
            --email admin@0379.email

  # ========================================
  # 部署
  # ========================================
  deploy:
    name: 部署
    runs-on: ubuntu-latest
    needs: [quality-check, database-sync-test, integration-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 部署到生产环境
        run: |
          echo "部署到生产环境..."
          # 这里添加实际的部署命令
          # bash scripts/deploy.sh

      - name: 发送部署通知
        run: |
          bash scripts/send-alert.sh \
            --type deploy \
            --subject "YYC³ 部署完成" \
            --message "已成功部署到生产环境" \
            --email admin@0379.email