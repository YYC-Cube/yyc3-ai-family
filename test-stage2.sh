#!/usr/bin/env bash
# ============================================================
# YYCÂ³ AI-Family - ç¬¬ 2 é˜¶æ®µ: å¤š Agent åä½œæµ‹è¯•
# æµ‹è¯• 5 ç§åä½œæ¨¡å¼çš„åŠŸèƒ½
# ============================================================

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[âœ“]${NC} $1"; }
log_error() { echo -e "${RED}[âœ—]${NC} $1"; }
log_test() { echo -e "${PURPLE}[TEST]${NC} $1"; }

# åˆ›å»ºæµ‹è¯•æŠ¥å‘Šç›®å½•
REPORT_DIR="test-reports-stage2-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$REPORT_DIR"

log_info "=== ç¬¬ 2 é˜¶æ®µ: å¤š Agent åä½œæµ‹è¯• ==="
echo ""

# ============================================================
# æµ‹è¯•çŽ¯å¢ƒå‡†å¤‡
# ============================================================

log_info "æ£€æŸ¥å¤š Agent åä½œç›¸å…³æ–‡ä»¶..."

required_files=(
    "src/lib/agent-orchestrator.ts"
    "src/app/components/console/AgentOrchestrator.tsx"
    "src/lib/agent-identity.ts"
)

all_files_exist=true
for file in "${required_files[@]}"; do
    if [ -f "$file" ] || [ -d "$file" ]; then
        log_success "âœ“ $file"
    else
        log_error "âœ— $file ä¸å­˜åœ¨"
        all_files_exist=false
    fi
done

if [ "$all_files_exist" = false ]; then
    log_error "ç¼ºå°‘å¿…è¦æ–‡ä»¶ï¼Œæ— æ³•ç»§ç»­æµ‹è¯•"
    exit 1
fi

echo ""
log_info "=== 5 ç§åä½œæ¨¡å¼æµ‹è¯•æ¸…å• ==="

cat > "$REPORT_DIR/test-cases.md" << 'EOF'
# ç¬¬ 2 é˜¶æ®µ: å¤š Agent åä½œæµ‹è¯•æ¸…å•

## åä½œæ¨¡å¼è¯´æ˜Ž

### 1. Pipelineï¼ˆä¸²è¡ŒæŽ¥åŠ›ï¼‰
- **æµç¨‹**: A â†’ B â†’ C â†’ D é¡ºåºæ‰§è¡Œ
- **ç”¨é€”**: ä»£ç å®¡æ ¸ã€å·¥ä½œæµå¤„ç†
- **é¢„è®¾æ¨¡æ¿**: code-review-pipeline
- **ç‰¹ç‚¹**: æ¯ä¸ªAgentä¾æ¬¡å¤„ç†å‰åºè¾“å‡º

### 2. Parallelï¼ˆå¹¶è¡Œæ±‡æ€»ï¼‰
- **æµç¨‹**: A + B + C + D â†’ Merge
- **ç”¨é€”**: å¤šè§’åº¦åˆ†æžã€çŸ¥è¯†åº“å¹¶è¡Œ
- **é¢„è®¾æ¨¡æ¿**: knowledge-parallel
- **ç‰¹ç‚¹**: åŒæ—¶æ‰§è¡Œï¼Œæœ€åŽæ±‡æ€»

### 3. Debateï¼ˆè¾©è®ºä»²è£ï¼‰
- **æµç¨‹**: A vs B â†’ Judge C
- **ç”¨é€”**: æ–¹æ¡ˆå¯¹æ¯”ã€æŠ€æœ¯å†³ç­–
- **é¢„è®¾æ¨¡æ¿**: architecture-debate
- **ç‰¹ç‚¹**: è§‚ç‚¹å¯¹ç«‹ï¼Œç¬¬ä¸‰æ–¹ä»²è£

### 4. Ensembleï¼ˆé›†æˆå…±è¯†ï¼‰
- **æµç¨‹**: A + B + C â†’ Consensus
- **ç”¨é€”**: å®‰å…¨è¯„ä¼°ã€é£Žé™©åˆ†æž
- **é¢„è®¾æ¨¡æ¿**: security-ensemble
- **ç‰¹ç‚¹**: ç‹¬ç«‹è¯„ä¼°ï¼Œå…±è¯†å†³ç­–

### 5. Delegationï¼ˆå§”æ‰˜åˆ†å·¥ï¼‰
- **æµç¨‹**: A â†’ [subTaskâ†’B, subTaskâ†’C]
- **ç”¨é€”**: DevOpsä»»åŠ¡ã€å¤æ‚é¡¹ç›®
- **é¢„è®¾æ¨¡æ¿**: devops-delegation
- **ç‰¹ç‚¹**: ä»»åŠ¡åˆ†è§£ï¼Œå¹¶è¡Œæ‰§è¡Œ

## æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

ç”±äºŽå¤š Agent åä½œéœ€è¦UIäº¤äº’ï¼Œä»¥ä¸‹æ˜¯è¯¦ç»†çš„æµ‹è¯•æ­¥éª¤ï¼š

### æ­¥éª¤ 1: å¯åŠ¨åº”ç”¨
```bash
bun run dev
# æ‰“å¼€ http://localhost:3113
```

### æ­¥éª¤ 2: è¿›å…¥ Agent Orchestrator
1. ç‚¹å‡»é¡¶æ çš„ "Agent Orchestrator" æˆ–å¯¼èˆªåˆ°ç›¸åº”é¡µé¢
2. æŸ¥çœ‹å¯ç”¨çš„é¢„è®¾æ¨¡æ¿å¡ç‰‡

### æ­¥éª¤ 3: æµ‹è¯•æ¨¡æ‹Ÿæ‰§è¡Œï¼ˆæ— éœ€API Keyï¼‰

#### æµ‹è¯• 3.1: Pipeline æ¨¡å¼
1. é€‰æ‹©é¢„è®¾ "ä»£ç å®¡æ ¸æµæ°´çº¿"
2. ç‚¹å‡» "åº”ç”¨é¢„è®¾"
3. ç¡®è®¤æ‰§è¡Œæ¨¡å¼ä¸º "Simulation"ï¼ˆæ¨¡æ‹Ÿï¼‰
4. ç‚¹å‡» "Launch Pipeline Collaboration"
5. è§‚å¯Ÿæ‰§è¡Œè¿‡ç¨‹:
   - Agent çŠ¶æ€å˜åŒ–ï¼ˆidle â†’ thinking â†’ executing â†’ doneï¼‰
   - æ—¶é—´çº¿äº‹ä»¶
   - æœ€ç»ˆåˆæˆæŠ¥å‘Š
6. éªŒè¯è¦ç‚¹:
   - âœ“ Navigator â†’ Thinker â†’ Sentinel é¡ºåºæ‰§è¡Œ
   - âœ“ æ¯ä¸ª Agent å¤„ç†å‰åºçš„è¾“å‡º
   - âœ“ æœ€ç»ˆæŠ¥å‘ŠåŒ…å«æ‰€æœ‰ Agent çš„è´¡çŒ®

#### æµ‹è¯• 3.2: Parallel æ¨¡å¼
1. é€‰æ‹©é¢„è®¾ "çŸ¥è¯†åº“å¹¶è¡Œåˆ†æž"
2. åº”ç”¨é¢„è®¾å¹¶å¯åŠ¨
3. éªŒè¯è¦ç‚¹:
   - âœ“ Thinker + Prophet + Bole åŒæ—¶æ‰§è¡Œ
   - âœ“ æœ€åŽç”± Grandmaster æ±‡æ€»
   - âœ“ å¹¶è¡Œæ‰§è¡Œçš„æ•ˆçŽ‡ä¼˜åŠ¿

#### æµ‹è¯• 3.3: Debate æ¨¡å¼
1. é€‰æ‹©é¢„è®¾ "æž¶æž„æ–¹æ¡ˆè¾©è®º"
2. åº”ç”¨é¢„è®¾å¹¶å¯åŠ¨
3. éªŒè¯è¦ç‚¹:
   - âœ“ Thinker vs Prophet è§‚ç‚¹å¯¹ç«‹
   - âœ“ Navigator è¿›è¡Œä»²è£
   - âœ“ æœ€ç»ˆçš„å¹³è¡¡ç»“è®º

#### æµ‹è¯• 3.4: Ensemble æ¨¡å¼
1. é€‰æ‹©é¢„è®¾ "å®‰å…¨è¯„ä¼°é›†æˆ"
2. åº”ç”¨é¢„è®¾å¹¶å¯åŠ¨
3. éªŒè¯è¦ç‚¹:
   - âœ“ æ‰€æœ‰ Agent ç‹¬ç«‹è¯„ä¼°
   - âœ“ å…±è¯†æœºåˆ¶è¿è¡Œ
   - âœ“ ç»¼åˆè¯„åˆ†ç»“æžœ

#### æµ‹è¯• 3.5: Delegation æ¨¡å¼
1. é€‰æ‹©é¢„è®¾ "DevOps å§”æ‰˜åˆ†å·¥"
2. åº”ç”¨é¢„è®¾å¹¶å¯åŠ¨
3. éªŒè¯è¦ç‚¹:
   - âœ“ Navigator åˆ†è§£ä»»åŠ¡
   - âœ“ Pivot/Prophet/Sentinel å¹¶è¡Œæ‰§è¡Œå­ä»»åŠ¡
   - âœ“ ä»»åŠ¡æ±‡æ€»å®Œæˆ

### æ­¥éª¤ 4: æµ‹è¯•è‡ªå®šä¹‰åˆ›å»º
1. é€‰æ‹©åä½œæ¨¡å¼ï¼ˆä»»æ„ä¸€ç§ï¼‰
2. è¾“å…¥ä»»åŠ¡æè¿°: "åˆ†æž React 18 çš„å¹¶å‘ç‰¹æ€§"
3. è§‚å¯Ÿç³»ç»ŸæŽ¨èçš„ Agent ç»„åˆ
4. å¯é€‰ï¼šæ‰‹åŠ¨è°ƒæ•´ Agent é€‰æ‹©
5. å¯åŠ¨æ‰§è¡Œ
6. éªŒè¯è¦ç‚¹:
   - âœ“ æŽ¨èç®—æ³•å‡†ç¡®æ€§
   - âœ“ Agent åˆ†é…åˆç†æ€§
   - âœ“ æ‰§è¡Œè¿‡ç¨‹æµç•…

### æ­¥éª¤ 5: æµ‹è¯•çœŸå®ž LLM æ‰§è¡Œï¼ˆå¯é€‰ï¼‰
1. ç¡®ä¿å·²é…ç½® Provider API Key
2. åˆ›å»ºæ–°ä»»åŠ¡æ—¶é€‰æ‹© "Real LLM" æ‰§è¡Œå¼•æ“Ž
3. è¾“å…¥æµ‹è¯•ä»»åŠ¡
4. å¯åŠ¨æ‰§è¡Œ
5. éªŒè¯è¦ç‚¹:
   - âœ“ çœŸå®žçš„ LLM API è°ƒç”¨
   - âœ“ Provider/Model ä¿¡æ¯æ˜¾ç¤º
   - âœ“ Token ä½¿ç”¨ç»Ÿè®¡
   - âœ“ å»¶è¿Ÿæ—¶é—´åˆç†

## é¢„æœŸç»“æžœ

### æ¨¡æ‹Ÿæ‰§è¡Œ
- âœ… Agent çŠ¶æ€æ­£ç¡®å˜åŒ–
- âœ… æ—¶é—´çº¿äº‹ä»¶å®Œæ•´
- âœ… è¾“å‡ºå†…å®¹åˆç†
- âœ… æ‰§è¡Œæ—¶é—´ 5-15 ç§’

### çœŸå®ž LLM æ‰§è¡Œ
- âœ… API è°ƒç”¨æˆåŠŸ
- âœ… å“åº”è´¨é‡é«˜
- âœ… Token ç»Ÿè®¡å‡†ç¡®
- âœ… å»¶è¿Ÿ 1-5 ç§’/Agent

## åŠŸèƒ½å®Œæ•´æ€§è¯„ä¼°

- [ ] Pipeline æ¨¡å¼å®Œå…¨å¯ç”¨
- [ ] Parallel æ¨¡å¼å®Œå…¨å¯ç”¨
- [ ] Debate æ¨¡å¼å®Œå…¨å¯ç”¨
- [ ] Ensemble æ¨¡å¼å®Œå…¨å¯ç”¨
- [ ] Delegation æ¨¡å¼å®Œå…¨å¯ç”¨

- [ ] æ¨¡æ‹Ÿæ‰§è¡ŒåŠŸèƒ½æ­£å¸¸
- [ ] çœŸå®ž LLM æ‰§è¡ŒåŠŸèƒ½æ­£å¸¸
- [ ] Agent æŽ¨èç®—æ³•å‡†ç¡®
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„

EOF

cat "$REPORT_DIR/test-cases.md"

log_success "æµ‹è¯•æ¸…å•å·²ç”Ÿæˆ: $REPORT_DIR/test-cases.md"

echo ""
log_info "=== è‡ªåŠ¨åŒ–ä»£ç æ£€æŸ¥ ==="

# æ£€æŸ¥ Agent Orchestrator ä»£ç 
log_test "æ£€æŸ¥ Agent Orchestrator å®žçŽ°..."

if grep -q "simulateCollaboration\|executeRealCollaboration" src/lib/agent-orchestrator.ts 2>/dev/null; then
    log_success "âœ“ åä½œæ‰§è¡Œå‡½æ•°å­˜åœ¨"
    echo "âœ… åä½œæ‰§è¡Œå‡½æ•°å­˜åœ¨" >> "$REPORT_DIR/results.txt"
else
    log_error "âœ— åä½œæ‰§è¡Œå‡½æ•°ä¸å­˜åœ¨"
    echo "âŒ åä½œæ‰§è¡Œå‡½æ•°ä¸å­˜åœ¨" >> "$REPORT_DIR/results.txt"
fi

# æ£€æŸ¥åä½œæ¨¡å¼å®šä¹‰
log_test "æ£€æŸ¥åä½œæ¨¡å¼å®šä¹‰..."

if grep -q "export type CollaborationMode" src/lib/agent-orchestrator.ts 2>/dev/null; then
    log_success "âœ“ åä½œæ¨¡å¼ç±»åž‹å®šä¹‰å­˜åœ¨"
    echo "âœ… åä½œæ¨¡å¼ç±»åž‹å®šä¹‰å­˜åœ¨" >> "$REPORT_DIR/results.txt"
fi

if grep -q "'pipeline'\|'parallel'\|'debate'\|'ensemble'\|'delegation'" src/lib/agent-orchestrator.ts 2>/dev/null; then
    log_success "âœ“ 5 ç§åä½œæ¨¡å¼å­—ç¬¦ä¸²å­˜åœ¨"
    echo "âœ… 5 ç§åä½œæ¨¡å¼å­—ç¬¦ä¸²å­˜åœ¨" >> "$REPORT_DIR/results.txt"
fi

# æ£€æŸ¥ UI ç»„ä»¶
log_test "æ£€æŸ¥ Agent Orchestrator UI ç»„ä»¶..."

if [ -f "src/app/components/console/AgentOrchestrator.tsx" ]; then
    log_success "âœ“ Agent Orchestrator UI ç»„ä»¶å­˜åœ¨"
    echo "âœ… Agent Orchestrator UI ç»„ä»¶å­˜åœ¨" >> "$REPORT_DIR/results.txt"

    # æ£€æŸ¥å…³é”®åŠŸèƒ½
    if grep -q "Pipeline\|Parallel\|Debate\|Ensemble\|Delegation" src/app/components/console/AgentOrchestrator.tsx 2>/dev/null; then
        log_success "âœ“ åä½œæ¨¡å¼ UI å®žçŽ°å­˜åœ¨"
        echo "âœ… åä½œæ¨¡å¼ UI å®žçŽ°å­˜åœ¨" >> "$REPORT_DIR/results.txt"
    fi
fi

echo ""
log_info "=== ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š ==="

cat > "$REPORT_DIR/stage2-report.md" << EOF
# ç¬¬ 2 é˜¶æ®µ: å¤š Agent åä½œ - æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¶é—´**: $(date)
**æµ‹è¯•ç±»åž‹**: åŠŸèƒ½éªŒè¯ + ä»£ç æ£€æŸ¥

## æµ‹è¯•ç»“æžœæ‘˜è¦

\`\`\`
$(cat "$REPORT_DIR/results.txt")
\`\`\`

## è¯¦ç»†æµ‹è¯•æ­¥éª¤

è¯·æŸ¥çœ‹: \`test-cases.md\`

## åŠŸèƒ½çŠ¶æ€

| åä½œæ¨¡å¼ | ä»£ç å®žçŽ° | UIç»„ä»¶ | éœ€è¦æ‰‹åŠ¨æµ‹è¯• |
|---------|---------|--------|-------------|
| Pipeline  | âœ… | âœ… | â³ |
| Parallel  | âœ… | âœ… | â³ |
| Debate    | âœ… | âœ… | â³ |
| Ensemble  | âœ… | âœ… | â³ |
| Delegation| âœ… | âœ… | â³ |

## ä»£ç æ£€æŸ¥ç»“æžœ

- [x] Agent Orchestrator æ ¸å¿ƒé€»è¾‘
- [x] åä½œæ¨¡å¼å®šä¹‰
- [x] UI ç»„ä»¶å®žçŽ°
- [x] æ¨¡æ‹Ÿæ‰§è¡Œå¼•æ“Ž
- [ ] çœŸå®ž LLM é›†æˆï¼ˆéœ€è¦ API Keyï¼‰

## ä¸‹ä¸€æ­¥

1. **æ‰‹åŠ¨æµ‹è¯•**: æŒ‰ç…§ test-cases.md ä¸­çš„æ­¥éª¤æµ‹è¯•
2. **åŠŸèƒ½éªŒè¯**: ç¡®ä¿ 5 ç§åä½œæ¨¡å¼éƒ½èƒ½æ­£å¸¸å·¥ä½œ
3. **é—®é¢˜ä¿®å¤**: è®°å½•å‘çŽ°çš„é—®é¢˜å¹¶ä¿®å¤
4. **ç¬¬ 3 é˜¶æ®µ**: æŒä¹…åŒ–æµ‹è¯•

## å…³é”®å‘çŽ°

### ä¼˜ç‚¹
- âœ… å®Œæ•´çš„å¤š Agent åä½œæ¡†æž¶
- âœ… 5 ç§åä½œæ¨¡å¼éƒ½æœ‰å®žçŽ°
- âœ… æ¨¡æ‹Ÿæ‰§è¡ŒåŠŸèƒ½å®Œå–„ï¼ˆæ— éœ€ API Key å³å¯æµ‹è¯•ï¼‰
- âœ… UI äº¤äº’è®¾è®¡åˆç†

### éœ€è¦æ³¨æ„
- âš ï¸ çœŸå®ž LLM æ‰§è¡Œéœ€è¦ API Key é…ç½®
- âš ï¸ åä½œæ¨¡å¼è¾ƒå¤æ‚ï¼Œéœ€è¦ä»”ç»†éªŒè¯
- âš ï¸ Agent æ•°é‡å¤šæ—¶å¯èƒ½æœ‰æ€§èƒ½é—®é¢˜

### å»ºè®®
1. ä¼˜å…ˆæµ‹è¯•æ¨¡æ‹Ÿæ‰§è¡Œï¼ˆæ— éœ€ API Keyï¼‰
2. éªŒè¯æ¯ç§åä½œæ¨¡å¼çš„æ‰§è¡Œæµç¨‹
3. æ£€æŸ¥ Agent é—´çš„æ•°æ®ä¼ é€’
4. æµ‹è¯•è¾¹ç•Œæƒ…å†µï¼ˆé•¿æ–‡æœ¬ã€è¶…æ—¶ç­‰ï¼‰

EOF

log_success "ç¬¬ 2 é˜¶æ®µæŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_DIR/stage2-report.md"

echo ""
log_success "=== ç¬¬ 2 é˜¶æ®µä»£ç æ£€æŸ¥å®Œæˆ ==="
echo ""
echo "ðŸ“Š æµ‹è¯•æŠ¥å‘Š: $REPORT_DIR/stage2-report.md"
echo "ðŸ“‹ æµ‹è¯•æ¸…å•: $REPORT_DIR/test-cases.md"
echo ""
echo "ðŸ” ä¸‹ä¸€æ­¥: æ‰‹åŠ¨æµ‹è¯•å¤š Agent åä½œåŠŸèƒ½"
echo ""
echo "   1. å¯åŠ¨åº”ç”¨: bun run dev"
echo "   2. æ‰“å¼€æµè§ˆå™¨: http://localhost:3113"
echo "   3. è¿›å…¥ Agent Orchestrator é¡µé¢"
echo "   4. æŒ‰ç…§æµ‹è¯•æ¸…å•é€é¡¹æµ‹è¯•"
echo ""
